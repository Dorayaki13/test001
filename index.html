<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr.QR Phase3 - æŒå‡ºè€…åæ©Ÿèƒ½ä»˜ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            font-weight: 800;
            line-height: 1.1;
        }
        
        .header p {
            font-size: 1.0rem;
            opacity: 0.9;
            margin: 0;
            line-height: 1.2;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            min-height: 75vh;
        }
        
        .left-panel {
            padding: 25px;
        }
        
        .right-panel {
            background: #f8fafc;
            border-left: 1px solid #e5e7eb;
            padding: 25px;
            overflow-y: auto;
            max-height: 75vh;
        }
        
        .scanner-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid #e5e7eb;
        }
        
        .scan-button {
            width: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .scan-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        /* æŒå‡ºè€…åé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .borrower-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid #e5e7eb;
        }
        
        .borrower-section h4 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .current-borrower {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .current-borrower.no-selection {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            box-shadow: 0 4px 15px rgba(156, 163, 175, 0.3);
        }
        
        .borrower-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 15px;
        }
        
        .borrower-btn {
            background: white;
            border: 2px solid #e5e7eb;
            color: #374151;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            font-weight: 500;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .borrower-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }
        
        .borrower-btn.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .borrower-btn.empty {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            color: #9ca3af;
            font-style: italic;
        }
        
        .borrower-btn.empty:hover {
            border-color: #6b7280;
            background: #f3f4f6;
        }
        
        .edit-borrower-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
            width: 100%;
            font-weight: 600;
        }
        
        .edit-borrower-btn:hover {
            background: #d97706;
        }
        
        .camera-container {
            display: none;
            position: relative;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }
        
        #video {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        
        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px solid #10b981;
            border-radius: 15px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.3);
        }
        
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .stop-button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .stop-button:hover {
            background: #dc2626;
        }
        
        .status-card {
            background: white;
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid #e5e7eb;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #6b7280;
            font-size: 16px;
        }
        
        .borrowed-instruments {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid #e5e7eb;
            min-height: 300px;
            max-height: 400px;
        }
        
        .borrowed-instruments h4 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .borrowed-list {
            max-height: 350px;
            overflow-y: auto;
        }
        
        .borrowed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }
        
        .borrowed-item:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .borrowed-info {
            flex: 1;
        }
        
        .borrowed-no {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
        }
        
        .borrowed-name {
            color: #6b7280;
            font-size: 12px;
            margin-top: 2px;
        }
        
        .borrowed-details {
            text-align: right;
            font-size: 11px;
        }
        
        .borrowed-user {
            color: #7c2d12;
            font-weight: 600;
        }
        
        .borrowed-datetime {
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }
        
        .stat-card.total .stat-number { color: #3b82f6; }
        .stat-card.available .stat-number { color: #10b981; }
        .stat-card.borrowed .stat-number { color: #f59e0b; }
        .stat-card.error .stat-number { color: #ef4444; }
        .stat-card.data-source .stat-number { color: #8b5cf6; font-size: 12px; font-weight: 600; }
        
        .status-available {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #10b981;
            color: #065f46;
        }
        
        .status-borrowed {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            color: #92400e;
        }
        
        .status-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            color: #991b1b;
        }
        

        
        .file-management {
            background: white;
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        
        .file-management h4 {
            color: #374151;
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 700;
        }
        
        .auto-save-status {
            margin-top: 10px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #0ea5e9;
            font-size: 12px;
            color: #0c4a6e;
        }
        
        .auto-save-status.saving {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .auto-save-status.error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        
        .save-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .save-button {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }
        
        .save-button:hover {
            background: #047857;
        }
        
        .save-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .activity-log {
            background: white;
            border-radius: 15px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        
        .activity-log h3 {
            color: #374151;
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .log-container {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 12px;
            border-left: 4px solid #e5e7eb;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            background: #f9fafb;
            transition: all 0.2s;
        }
        
        .log-entry:hover {
            background: #f3f4f6;
        }
        
        .log-entry.borrow {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        .log-entry.return {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }
        
        .log-entry.system {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        
        .log-entry.file {
            border-left-color: #8b5cf6;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
        }
        
        .log-entry.error {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }
        
        .log-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .log-action {
            font-weight: 700;
            color: #1f2937;
            font-size: 15px;
        }
        
        .log-time {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 500;
        }
        
        .log-details {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
            font-weight: 500;
        }
        
        .current-file-info {
            background: #f8fafc;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .current-file-info h5 {
            color: #475569;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .file-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
            font-size: 11px;
        }
        
        .file-info-label {
            color: #64748b;
        }
        
        .file-info-value {
            color: #1e293b;
            font-weight: 500;
        }
        
        .audio-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            pointer-events: none;
            font-size: 3rem;
            animation: audioFeedback 0.6s ease-out;
        }
        
        .audio-feedback.success {
            color: #10b981;
        }
        
        .audio-feedback.error {
            color: #ef4444;
        }
        
        @keyframes audioFeedback {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œä¿®æ­£ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-header h3 {
            color: #374151;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .close {
            color: #9ca3af;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close:hover {
            color: #374151;
        }
        
        .borrower-edit-grid {
            display: grid;
            gap: 15px;
            padding: 10px 0;
        }
        
        .borrower-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .borrower-input-group label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        
        .borrower-input-group input {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        .borrower-input-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            position: sticky;
            bottom: 0;
            background: white;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn.primary {
            background: #3b82f6;
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: #2563eb;
        }
        
        .modal-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .modal-btn.secondary:hover {
            background: #e5e7eb;
        }
        
        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 1fr 350px;
            }
            
            .right-panel {
                padding: 20px;
            }
            
            .left-panel {
                padding: 20px;
            }
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                border-left: none;
                border-top: 1px solid #e5e7eb;
                max-height: 60vh;
            }
            
            .stats-section {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .borrower-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
                line-height: 1.1;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .main-layout {
                min-height: 70vh;
            }
            
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .container {
                border-radius: 0;
                min-height: 100vh;
            }
            
            .save-controls {
                grid-template-columns: 1fr;
            }
            
            .borrowed-instruments {
                min-height: 250px;
                max-height: 300px;
            }
            
            .borrowed-list {
                max-height: 250px;
            }
            
            .borrower-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .modal-content {
                margin: 2% auto;
                padding: 20px;
                max-height: 95vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ ï¼­ï½’.ï¼±ï¼²ã€€Phase3</h1>
            <p>QRã‚³ãƒ¼ãƒ‰æŒå‡ºãƒ»è¿”å´ç®¡ç† - æŒå‡ºè€…åæ©Ÿèƒ½ä»˜ã</p>
        </div>
        
        <div class="main-layout">
            <!-- å·¦ãƒ‘ãƒãƒ«: ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="left-panel">
                <!-- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="scanner-section">
                    <button class="scan-button" id="scanButton" onclick="toggleScanner()">
                        ğŸ“· ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
                    </button>
                    
                    <div class="camera-container" id="cameraContainer">
                        <video id="video" autoplay playsinline></video>
                        <div class="camera-overlay"></div>
                        <div class="camera-controls">
                            <button class="stop-button" onclick="stopScanner()">
                                ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- æŒå‡ºè€…åé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="borrower-section">
                    <h4>ğŸ‘¤ æŒå‡ºè€…é¸æŠ</h4>
                    
                    <div class="current-borrower" id="currentBorrower">
                        æŒå‡ºè€…ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“
                    </div>
                    
                    <div class="borrower-buttons" id="borrowerButtons">
                        <!-- æŒå‡ºè€…ãƒœã‚¿ãƒ³ãŒã“ã“ã«å‹•çš„ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <button class="edit-borrower-btn" onclick="openBorrowerEditor()">
                        âœï¸ æŒå‡ºè€…åã‚’ç·¨é›†
                    </button>
                </div>
                
                <!-- çŠ¶æ…‹è¡¨ç¤º -->
                <div id="statusCard" class="status-card">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>
                
                <!-- æŒå‡ºä¸­æ©Ÿå™¨è¡¨ç¤º -->
                <div class="borrowed-instruments">
                    <h4>ğŸ“¤ æŒå‡ºä¸­ã®æ©Ÿå™¨</h4>
                    <div class="borrowed-list" id="borrowedList"></div>
                </div>
                

            </div>
            
            <!-- å³ãƒ‘ãƒãƒ«: çµ±è¨ˆã¨ç®¡ç† -->
            <div class="right-panel">
                <!-- çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="stats-section">
                    <div class="stat-card total">
                        <div class="stat-number" id="totalCount">0</div>
                        <div class="stat-label">ç·æ•°</div>
                    </div>
                    <div class="stat-card available">
                        <div class="stat-number" id="availableCount">0</div>
                        <div class="stat-label">åˆ©ç”¨å¯èƒ½</div>
                    </div>
                    <div class="stat-card borrowed">
                        <div class="stat-number" id="borrowedCount">0</div>
                        <div class="stat-label">æŒå‡ºä¸­</div>
                    </div>
                    <div class="stat-card error">
                        <div class="stat-number" id="errorCount">0</div>
                        <div class="stat-label">ã‚¨ãƒ©ãƒ¼</div>
                    </div>
                    <div class="stat-card data-source">
                        <div class="stat-number" id="dataSourceLabel">ãƒ•ã‚¡ã‚¤ãƒ«</div>
                        <div class="stat-label">ãƒ‡ãƒ¼ã‚¿</div>
                    </div>
                </div>
                
                <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="file-management">
                    <h4>ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†</h4>
                    
                    <!-- LocalStorageè‡ªå‹•ä¿å­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div style="margin: 0 0 15px 0; padding: 12px; background: #f0fdf4; border-radius: 8px; border: 2px solid #16a34a;">
                        <strong style="color: #15803d; font-size: 14px;">ğŸ”„ ãƒ¡ã‚¤ãƒ³ä¿å­˜ï¼šLocalStorageè‡ªå‹•ä¿å­˜</strong><br>
                        <div style="font-size: 11px; color: #16a34a; margin: 5px 0;">
                            âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONã€€âœ… èµ·å‹•æ™‚è‡ªå‹•èª­ã¿è¾¼ã¿ã€€âœ… ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚è‡ªå‹•ä¿å­˜ã€€âœ… çµ‚äº†æ™‚è‡ªå‹•ä¿å­˜
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
                            <button id="autoSaveToggle" onclick="toggleAutoSave()" style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                ğŸ”‡ è‡ªå‹•ä¿å­˜OFF
                            </button>
                            <button onclick="clearLocalStorageData()" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                ğŸ—‘ï¸ è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                            </button>
                        </div>
                        <div id="autoSaveDisplay" style="font-size: 11px; color: #059669; margin-top: 6px; font-weight: 600;">
                            ğŸ”„ è‡ªå‹•ä¿å­˜æœ‰åŠ¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
                        </div>
                    </div>
                    
                    <!-- ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± -->
                    <div class="current-file-info">
                        <h5>ğŸ“Š ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³</h5>
                        <div class="file-info-item">
                            <span class="file-info-label">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</span>
                            <span class="file-info-value" id="currentFileName">LocalStorageè‡ªå‹•ä¿å­˜</span>
                        </div>
                        <div class="file-info-item">
                            <span class="file-info-label">æœ€çµ‚æ›´æ–°:</span>
                            <span class="file-info-value" id="lastModified">-</span>
                        </div>
                        <div class="file-info-item">
                            <span class="file-info-label">æ©Ÿå™¨æ•°:</span>
                            <span class="file-info-value" id="fileInstrumentCount">0å°</span>
                        </div>
                    </div>
                    
                    <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ -->
                    <div style="margin: 12px 0; padding: 10px; background: #fefbf3; border-radius: 8px; border: 1px solid #f59e0b;">
                        <strong style="color: #d97706; font-size: 13px;">ğŸ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ</strong><br>
                        <div style="font-size: 10px; color: #92400e; margin: 4px 0;">
                            å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆç”¨
                        </div>
                        
                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                        <div class="save-controls" style="margin-top: 8px;">
                            <button class="save-button" style="background: #3b82f6;" onclick="loadNewFile()">
                                ğŸ“‚ JSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                            </button>
                            <button class="save-button" style="background: #8b5cf6;" onclick="loadSampleData()">
                                ğŸ”§ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                            </button>
                        </div>
                        
                        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                        <div class="save-controls">
                            <button class="save-button" onclick="manualSave()">
                                ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
                            </button>
                            <button class="save-button" style="background: #059669;" onclick="exportBackup()">
                                ğŸ“¤ æ—¥æ™‚ä»˜ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                            </button>
                        </div>
                    </div>
                    
                    <!-- ä¿å­˜æ–¹å¼ã®èª¬æ˜ -->
                    <div style="margin: 8px 0; padding: 8px; background: #f0f9ff; border-radius: 8px; font-size: 10px; color: #0c4a6e;">
                        <strong>ğŸ’¡ ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦</strong><br>
                        ğŸ”„ <strong>ãƒ¡ã‚¤ãƒ³</strong>: LocalStorageè‡ªå‹•ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è‡ªå‹•ç®¡ç†ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰<br>
                        ğŸ“¤ <strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</strong>: æ‰‹å‹•ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆä»–ç«¯æœ«å…±æœ‰ãƒ»é•·æœŸä¿å­˜ç”¨ï¼‰<br>
                        ğŸ“ <strong>ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿</strong>: å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿<br>
                        <span id="fileSystemSupport"></span>
                    </div>
                    
                    <!-- ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                    <div class="save-controls" style="margin-top: 8px;">
                        <button class="save-button" style="background: #6b7280;" onclick="debugInstruments()">
                            ğŸ” ãƒ‡ãƒ¼ã‚¿è©³ç´°ç¢ºèª
                        </button>
                        <button class="save-button" style="background: #dc2626;" onclick="validateInstrumentsData()">
                            âš ï¸ æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                        </button>
                    </div>
                    
                    <!-- æ‰‹å‹•ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                    <div class="auto-save-status" id="autoSaveStatus">
                        <strong>ğŸ“¤ è‡ªå‹•ä¿å­˜ãƒ¡ã‚¤ãƒ³é‹ç”¨</strong><br>
                        <span id="autoSaveMessage">LocalStorageè‡ªå‹•ä¿å­˜ãŒãƒ¡ã‚¤ãƒ³å‹•ä½œä¸­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰</span>
                    </div>
                    
                    <input type="file" id="fileInput" accept=".json" style="display: none;" />
                    
                    <p style="font-size: 11px; color: #6b7280; margin-top: 12px;">
                        ğŸ’¡ <strong>æ¨å¥¨é‹ç”¨æ–¹æ³•:</strong><br>
                        ğŸ“‚ é€šå¸¸: LocalStorageè‡ªå‹•ä¿å­˜ã§é‹ç”¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰<br>
                        ğŸ’¾ å®šæœŸçš„: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã§å¤–éƒ¨ä¿å­˜<br>
                        ğŸ”„ ç§»è¡Œæ™‚: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã§ä»–ç«¯æœ«ã‹ã‚‰ç§»è¡Œ<br>
                        ğŸŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç«¯æœ«é–“ã§å…±æœ‰å¯èƒ½
                    </p>
                </div>
                
                <!-- éŸ³å£°è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="file-management">
                    <h4>ğŸµ éŸ³å£°è¨­å®š</h4>
                    
                    <!-- ç¾åœ¨ã®éŸ³å£°è¨­å®šçŠ¶æ³ -->
                    <div class="current-file-info">
                        <h5>ğŸ”Š ç¾åœ¨ã®éŸ³å£°è¨­å®š</h5>
                        <div class="file-info-item">
                            <span class="file-info-label">æŒå‡ºéŸ³:</span>
                            <span class="file-info-value" id="borrowSoundStatus">ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬+éŸ³å£°åˆæˆ</span>
                        </div>
                        <div class="file-info-item">
                            <span class="file-info-label">è¿”å´éŸ³:</span>
                            <span class="file-info-value" id="returnSoundStatus">çˆ†ç™ºéŸ³+éŸ³å£°åˆæˆ</span>
                        </div>
                    </div>
                    
                    <!-- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š -->
                    <div style="margin: 12px 0; padding: 10px; background: #f0f9ff; border-radius: 8px; border: 1px solid #3b82f6;">
                        <strong style="color: #1d4ed8; font-size: 13px;">ğŸ¤ ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«</strong><br>
                        <div style="font-size: 10px; color: #1e40af; margin: 4px 0;">
                            MP3ã€WAVã€OGGå½¢å¼ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
                        </div>
                        
                        <!-- æŒå‡ºéŸ³è¨­å®š -->
                        <div class="save-controls" style="margin-top: 8px;">
                            <button class="save-button" style="background: #10b981;" onclick="document.getElementById('borrowSoundInput').click()">
                                ğŸ“¤ æŒå‡ºéŸ³ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                            </button>
                            <button class="save-button" style="background: #ef4444;" onclick="clearCustomSound('borrow'); updateSoundStatus();">
                                ğŸ—‘ï¸ æŒå‡ºéŸ³ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                        
                        <!-- è¿”å´éŸ³è¨­å®š -->
                        <div class="save-controls">
                            <button class="save-button" style="background: #f59e0b;" onclick="document.getElementById('returnSoundInput').click()">
                                ğŸ“¥ è¿”å´éŸ³ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                            </button>
                            <button class="save-button" style="background: #ef4444;" onclick="clearCustomSound('return'); updateSoundStatus();">
                                ğŸ—‘ï¸ è¿”å´éŸ³ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                        
                        <!-- ãƒ†ã‚¹ãƒˆå†ç”Ÿ -->
                        <div class="save-controls">
                            <button class="save-button" style="background: #8b5cf6;" onclick="playSuccessSound()">
                                ğŸµ æŒå‡ºéŸ³ãƒ†ã‚¹ãƒˆ
                            </button>
                            <button class="save-button" style="background: #8b5cf6;" onclick="playReturnSound()">
                                ğŸµ è¿”å´éŸ³ãƒ†ã‚¹ãƒˆ
                            </button>
                        </div>
                    </div>
                    
                    <!-- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª¬æ˜ -->
                    <div style="margin: 8px 0; padding: 8px; background: #fef3c7; border-radius: 8px; font-size: 10px; color: #92400e;">
                        <strong>ğŸ’¡ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦</strong><br>
                        ğŸ“ å¯¾å¿œå½¢å¼: MP3, WAV, OGG, M4A<br>
                        â±ï¸ æ¨å¥¨é•·ã•: 1ã€œ3ç§’ç¨‹åº¦<br>
                        ğŸ”Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 1MBä»¥ä¸‹æ¨å¥¨<br>
                        ğŸ¯ è¨­å®šå¾Œã¯ãƒ†ã‚¹ãƒˆå†ç”Ÿã§ç¢ºèªå¯èƒ½
                    </div>
                    
                    <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
                    <input type="file" id="borrowSoundInput" accept="audio/*" style="display: none;" />
                    <input type="file" id="returnSoundInput" accept="audio/*" style="display: none;" />
                </div>
                
                <!-- æ´»å‹•ãƒ­ã‚° -->
                <div class="activity-log">
                    <h3>ğŸ“‹ æ´»å‹•ãƒ­ã‚°</h3>
                    <div class="log-container" id="activityLog"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒå‡ºè€…åç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="borrowerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ‘¤ æŒå‡ºè€…åç·¨é›†</h3>
                <span class="close" onclick="closeBorrowerEditor()">&times;</span>
            </div>
            <div class="borrower-edit-grid" id="borrowerEditGrid">
                <!-- æŒå‡ºè€…åå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã“ã“ã«å‹•çš„ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeBorrowerEditor()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn primary" onclick="saveBorrowerNames()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let stream = null;
        let instruments = new Map();
        let activityLog = [];
        let isScanning = false;
        let animationId = null;
        let lastScannedCode = null;
        let lastScannedTime = 0;
        const SCAN_COOLDOWN = 3000;
        let dataSource = 'ãƒ•ã‚¡ã‚¤ãƒ«';
        let currentFileName = '';
        let lastSaveTime = null;
        let autoSaveInterval = null;
        const DATA_FILENAME = 'mr_qr_data.json';
        
        // LocalStorageè‡ªå‹•ä¿å­˜é–¢é€£ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
        const LOCALSTORAGE_KEY = 'mr_qr_auto_save_data';
        let autoSaveEnabled = true;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON
        let lastAutoSaveTime = null;
        
        // æŒå‡ºè€…åç®¡ç†é–¢é€£
        const BORROWER_NAMES_KEY = 'mr_qr_borrower_names';
        let borrowerNames = [];
        let selectedBorrowerIndex = -1;
        
        // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰+ å¤–éƒ¨éŸ³å£°å¯¾å¿œ
        let audioContext = null;
        let isAudioEnabled = true;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON
        let audioInitialized = false;
        
        // å¤–éƒ¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç”¨
        let customBorrowSound = null;  // æŒå‡ºéŸ³ç”¨
        let customReturnSound = null;  // è¿”å´éŸ³ç”¨
        
        // å¤–éƒ¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
        function loadAudioFile(file, type) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (!audioContext) {
                        reject(new Error('AudioContext ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“'));
                        return;
                    }
                    
                    audioContext.decodeAudioData(e.target.result)
                        .then(audioBuffer => {
                            if (type === 'borrow') {
                                customBorrowSound = audioBuffer;
                                console.log('ğŸ“¤ æŒå‡ºéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
                                addToLog('SYSTEM', 'æŒå‡ºéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š', `ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}`);
                            } else if (type === 'return') {
                                customReturnSound = audioBuffer;
                                console.log('ğŸ“¥ è¿”å´éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
                                addToLog('SYSTEM', 'è¿”å´éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š', `ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}`);
                            }
                            resolve(audioBuffer);
                        })
                        .catch(error => {
                            console.error('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                            reject(error);
                        });
                };
                reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                reader.readAsArrayBuffer(file);
            });
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°ã®å†ç”Ÿ
        function playCustomSound(audioBuffer) {
            if (!audioContext || !audioBuffer) return;
            
            try {
                const source = audioContext.createBufferSource();
                const gainNode = audioContext.createGain();
                
                source.buffer = audioBuffer;
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // éŸ³é‡èª¿æ•´ï¼ˆå°‘ã—ä¸Šã’ã¦èãã‚„ã™ãï¼‰
                gainNode.gain.setValueAtTime(0.9, audioContext.currentTime);
                
                source.start(audioContext.currentTime);
                console.log('ğŸµ ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°å†ç”Ÿ');
            } catch (error) {
                console.warn('âš ï¸ ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°ã®ã‚¯ãƒªã‚¢
        function clearCustomSound(type) {
            if (type === 'borrow') {
                customBorrowSound = null;
                console.log('ğŸ“¤ æŒå‡ºéŸ³å£°ã‚’ã‚¯ãƒªã‚¢');
                addToLog('SYSTEM', 'æŒå‡ºéŸ³å£°ã‚’ã‚¯ãƒªã‚¢', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬+éŸ³å£°åˆæˆã«æˆ»ã—ã¾ã™');
            } else if (type === 'return') {
                customReturnSound = null;
                console.log('ğŸ“¥ è¿”å´éŸ³å£°ã‚’ã‚¯ãƒªã‚¢');
                addToLog('SYSTEM', 'è¿”å´éŸ³å£°ã‚’ã‚¯ãƒªã‚¢', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çˆ†ç™ºéŸ³+éŸ³å£°åˆæˆã«æˆ»ã—ã¾ã™');
            }
        }
        function initBorrowerNames() {
            // LocalStorageã‹ã‚‰æŒå‡ºè€…åã‚’èª­ã¿è¾¼ã¿
            const savedNames = localStorage.getItem(BORROWER_NAMES_KEY);
            if (savedNames) {
                try {
                    borrowerNames = JSON.parse(savedNames);
                } catch (error) {
                    console.warn('æŒå‡ºè€…åãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                    borrowerNames = [];
                }
            }
            
            // åˆæœŸå€¤ã¾ãŸã¯ä¸è¶³åˆ†ã‚’è£œå®Œï¼ˆ16åã«æ‹¡å¼µï¼‰
            while (borrowerNames.length < 16) {
                borrowerNames.push('');
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã‚’è¨­å®šï¼ˆç©ºã®å ´åˆã®ã¿ï¼‰
            const defaultNames = [
                'ç”°ä¸­', 'ä½è—¤', 'éˆ´æœ¨', 'é«˜æ©‹', 'ä¼Šè—¤',
                'æ¸¡è¾º', 'å±±æœ¬', 'ä¸­æ‘', 'å°æ—', 'åŠ è—¤',
                'å‰ç”°', 'å±±ç”°', 'æ¾æœ¬', 'äº•ä¸Š', 'æœ¨æ‘', 'æ—'
            ];
            
            borrowerNames = borrowerNames.map((name, index) => 
                name.trim() || defaultNames[index] || ''
            );
            
            // é…åˆ—ã®é•·ã•ã‚’16ã«å›ºå®š
            borrowerNames = borrowerNames.slice(0, 16);
            
            saveBorrowerNamesToStorage();
            updateBorrowerButtons();
        }
        
        // æŒå‡ºè€…åã‚’LocalStorageã«ä¿å­˜
        function saveBorrowerNamesToStorage() {
            try {
                localStorage.setItem(BORROWER_NAMES_KEY, JSON.stringify(borrowerNames));
            } catch (error) {
                console.warn('æŒå‡ºè€…åã®ä¿å­˜ã«å¤±æ•—:', error);
            }
        }
        
        // æŒå‡ºè€…ãƒœã‚¿ãƒ³ã®æ›´æ–°
        function updateBorrowerButtons() {
            const container = document.getElementById('borrowerButtons');
            container.innerHTML = '';
            
            borrowerNames.forEach((name, index) => {
                const button = document.createElement('button');
                button.className = 'borrower-btn';
                
                if (name.trim()) {
                    button.textContent = name;
                    button.onclick = () => selectBorrower(index);
                    
                    if (index === selectedBorrowerIndex) {
                        button.classList.add('selected');
                    }
                } else {
                    button.textContent = 'æœªè¨­å®š';
                    button.classList.add('empty');
                    button.onclick = () => openBorrowerEditor();
                }
                
                container.appendChild(button);
            });
            
            updateCurrentBorrowerDisplay();
        }
        
        // æŒå‡ºè€…ã®é¸æŠ
        function selectBorrower(index) {
            if (borrowerNames[index].trim()) {
                selectedBorrowerIndex = index;
                updateBorrowerButtons();
                updateCurrentBorrowerDisplay();
                
                addToLog('SYSTEM', 'æŒå‡ºè€…ã‚’é¸æŠ', `${borrowerNames[index]} ã‚’é¸æŠã—ã¾ã—ãŸ`);
                console.log(`æŒå‡ºè€…é¸æŠ: ${borrowerNames[index]} (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${index})`);
            }
        }
        
        // ç¾åœ¨ã®æŒå‡ºè€…è¡¨ç¤ºã‚’æ›´æ–°
        function updateCurrentBorrowerDisplay() {
            const display = document.getElementById('currentBorrower');
            
            if (selectedBorrowerIndex >= 0 && borrowerNames[selectedBorrowerIndex].trim()) {
                display.textContent = `é¸æŠä¸­: ${borrowerNames[selectedBorrowerIndex]}`;
                display.className = 'current-borrower';
            } else {
                display.textContent = 'æŒå‡ºè€…ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
                display.className = 'current-borrower no-selection';
            }
        }
        
        // æŒå‡ºè€…åç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openBorrowerEditor() {
            const modal = document.getElementById('borrowerModal');
            const editGrid = document.getElementById('borrowerEditGrid');
            
            editGrid.innerHTML = '';
            
            borrowerNames.forEach((name, index) => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'borrower-input-group';
                
                inputGroup.innerHTML = `
                    <label for="borrower-${index}">æŒå‡ºè€… ${index + 1}</label>
                    <input type="text" id="borrower-${index}" value="${name}" placeholder="æŒå‡ºè€…åã‚’å…¥åŠ›..." maxlength="20" />
                `;
                
                editGrid.appendChild(inputGroup);
            });
            
            modal.style.display = 'block';
        }
        
        // æŒå‡ºè€…åç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeBorrowerEditor() {
            document.getElementById('borrowerModal').style.display = 'none';
        }
        
        // æŒå‡ºè€…åã‚’ä¿å­˜
        function saveBorrowerNames() {
            const newNames = [];
            
            for (let i = 0; i < 16; i++) {
                const input = document.getElementById(`borrower-${i}`);
                if (input) {
                    newNames.push(input.value.trim());
                }
            }
            
            borrowerNames = newNames;
            saveBorrowerNamesToStorage();
            updateBorrowerButtons();
            closeBorrowerEditor();
            
            addToLog('SYSTEM', 'æŒå‡ºè€…åã‚’æ›´æ–°', `${newNames.filter(n => n).length}åã®æŒå‡ºè€…ã‚’è¨­å®šã—ã¾ã—ãŸ`);
            console.log('æŒå‡ºè€…åæ›´æ–°:', borrowerNames);
            
            // è‡ªå‹•ä¿å­˜ãƒˆãƒªã‚¬ãƒ¼
            triggerAutoSave();
        }
        
        // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
        function initAudioSystem() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('ğŸµ éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰');
                    
                    if (audioContext.state === 'suspended') {
                        console.log('ğŸµ éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œã«è‡ªå‹•æœ‰åŠ¹åŒ–äºˆå®š');
                    } else {
                        console.log('ğŸ”Š éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ : æœ‰åŠ¹');
                    }
                }
                audioInitialized = true;
                return true;
            } catch (error) {
                console.warn('âš ï¸ Web Audio APIåˆæœŸåŒ–å¤±æ•—:', error);
                isAudioEnabled = false;
                return false;
            }
        }
        
        // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
        function activateAudioSystem() {
            if (!audioInitialized) {
                initAudioSystem();
            }
            
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('ğŸµ éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆå®Œäº†');
                    playBeepSound(800, 150, 'success');
                }).catch(error => {
                    console.warn('âš ï¸ éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆå¤±æ•—:', error);
                });
            } else if (audioContext && audioContext.state === 'running') {
                playBeepSound(800, 150, 'success');
            }
        }
        
        // ãƒ“ãƒ¼ãƒ—éŸ³ã®ç”Ÿæˆãƒ»å†ç”Ÿ
        function playBeepSound(frequency = 800, duration = 200, type = 'success') {
            showVisualFeedback(type);
            
            if (!isAudioEnabled || !audioContext) {
                console.log('ğŸ”‡ éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ç„¡åŠ¹ - è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿');
                return;
            }
            
            try {
                if (audioContext.state === 'suspended') {
                    console.log('ğŸ”‡ AudioContext suspended - è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿');
                    return;
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                const startTime = audioContext.currentTime;
                const endTime = startTime + duration / 1000;
                
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01); // 0.15 â†’ 0.3
                gainNode.gain.exponentialRampToValueAtTime(0.001, endTime - 0.01);
                gainNode.gain.setValueAtTime(0, endTime);
                
                oscillator.start(startTime);
                oscillator.stop(endTime);
                
                console.log(`ğŸµ ãƒ“ãƒ¼ãƒ—éŸ³å†ç”Ÿ: ${frequency}Hz, ${duration}ms (${type})`);
                
            } catch (error) {
                console.warn('âš ï¸ ãƒ“ãƒ¼ãƒ—éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        function showVisualFeedback(type) {
            const feedback = document.createElement('div');
            feedback.className = `audio-feedback ${type}`;
            
            if (type === 'success') {
                feedback.textContent = 'âœ…';
            } else if (type === 'error') {
                feedback.textContent = 'âŒ';
            }
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.remove();
                }
            }, 600);
        }
        
        // æŒå‡ºéŸ³ã®å†ç”Ÿï¼ˆã‚«ã‚¹ã‚¿ãƒ éŸ³å£°å¯¾å¿œï¼‰
        function playSuccessSound() {
            console.log('ğŸµ æŒå‡ºéŸ³å†ç”Ÿé–‹å§‹');
            
            // ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆéŸ³å£°åˆæˆãªã—ï¼‰
            if (customBorrowSound) {
                playCustomSound(customBorrowSound);
                return;
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ + éŸ³å£°åˆæˆ
            if (audioContext && audioContext.state === 'running') {
                playFanfareSound();
                // éŸ³å£°åˆæˆã‚‚å†ç”Ÿï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³ã®å ´åˆã®ã¿ï¼‰
                setTimeout(() => speakText('ã‚‚ã¡ã ã—'), 100);
            } else {
                console.log('ğŸ”„ Web Audio APIä½¿ç”¨ä¸å¯ - è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿');
                showVisualFeedback('success');
                
                setTimeout(() => {
                    if (audioContext && audioContext.state === 'running') {
                        playFanfareSound();
                        setTimeout(() => speakText('ã‚‚ã¡ã ã—'), 100);
                    }
                }, 100);
            }
        }
        
        // è¿”å´éŸ³ã®å†ç”Ÿï¼ˆã‚«ã‚¹ã‚¿ãƒ éŸ³å£°å¯¾å¿œï¼‰
        function playReturnSound() {
            console.log('ğŸµ è¿”å´éŸ³å†ç”Ÿé–‹å§‹');
            
            // ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆéŸ³å£°åˆæˆãªã—ï¼‰
            if (customReturnSound) {
                playCustomSound(customReturnSound);
                return;
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çˆ†ç™ºéŸ³ + éŸ³å£°åˆæˆ
            if (audioContext && audioContext.state === 'running') {
                playExplosionSound();
                // éŸ³å£°åˆæˆã‚‚å†ç”Ÿï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³ã®å ´åˆã®ã¿ï¼‰
                setTimeout(() => speakText('ã¸ã‚“ãã‚ƒã'), 200);
            } else {
                console.log('ğŸ”„ Web Audio APIä½¿ç”¨ä¸å¯ - è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿');
                showVisualFeedback('success'); // è¿”å´ã¯æˆåŠŸãªã®ã§ç·‘è‰²
                
                setTimeout(() => {
                    if (audioContext && audioContext.state === 'running') {
                        playExplosionSound();
                        setTimeout(() => speakText('ã¸ã‚“ãã‚ƒã'), 200);
                    }
                }, 100);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼éŸ³ã®å†ç”Ÿï¼ˆå¾“æ¥ã®ã‚¨ãƒ©ãƒ¼éŸ³ã‚’ç¶­æŒï¼‰
        function playErrorSound() {
            console.log('ğŸµ ã‚¨ãƒ©ãƒ¼éŸ³å†ç”Ÿé–‹å§‹ï¼ˆæ®‹å¿µé¢¨ï¼‰');
            
            if (audioContext && audioContext.state === 'running') {
                // ä¸‹é™éŸ³éšï¼ˆæ®‹å¿µéŸ³é¢¨ï¼‰
                playBeepSound(392, 200, 'error'); // ã‚½ï¼ˆG4ï¼‰
                setTimeout(() => playBeepSound(330, 200, 'error'), 250); // ãƒŸï¼ˆE4ï¼‰
                setTimeout(() => playBeepSound(262, 400, 'error'), 500); // ãƒ‰ï¼ˆC4ï¼‰ï¼ˆé•·ã‚ï¼‰
            } else {
                console.log('ğŸ”„ Web Audio APIä½¿ç”¨ä¸å¯ - è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿');
                showVisualFeedback('error');
                
                setTimeout(() => {
                    if (audioContext && audioContext.state === 'running') {
                        playBeepSound(392, 200, 'error');
                        setTimeout(() => playBeepSound(330, 200, 'error'), 250);
                        setTimeout(() => playBeepSound(262, 400, 'error'), 500);
                    }
                }, 100);
            }
        }
        
        // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬éŸ³ã®ç”Ÿæˆ
        function playFanfareSound() {
            try {
                const now = audioContext.currentTime;
                
                // ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼éƒ¨åˆ†ï¼ˆä¸»æ—‹å¾‹ï¼‰
                const melody = [
                    { freq: 523, start: 0.0, duration: 0.15 }, // ãƒ‰
                    { freq: 659, start: 0.15, duration: 0.15 }, // ãƒŸ
                    { freq: 784, start: 0.3, duration: 0.2 }, // ã‚½
                    { freq: 1047, start: 0.5, duration: 0.3 }, // é«˜ã„ãƒ‰
                ];
                
                // ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼éƒ¨åˆ†
                const harmony = [
                    { freq: 415, start: 0.0, duration: 0.15 }, // ã‚½# (ä½)
                    { freq: 523, start: 0.15, duration: 0.15 }, // ãƒ‰
                    { freq: 622, start: 0.3, duration: 0.2 }, // ãƒŸâ™­
                    { freq: 784, start: 0.5, duration: 0.3 }, // ã‚½
                ];
                
                // ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼å†ç”Ÿï¼ˆéŸ³é‡ã‚¢ãƒƒãƒ—ï¼‰
                melody.forEach(note => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    
                    osc.frequency.setValueAtTime(note.freq, now + note.start);
                    osc.type = 'triangle';
                    
                    gain.gain.setValueAtTime(0, now + note.start);
                    gain.gain.linearRampToValueAtTime(0.5, now + note.start + 0.02); // 0.2 â†’ 0.5
                    gain.gain.exponentialRampToValueAtTime(0.001, now + note.start + note.duration);
                    
                    osc.start(now + note.start);
                    osc.stop(now + note.start + note.duration);
                });
                
                // ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼å†ç”Ÿï¼ˆéŸ³é‡ã‚¢ãƒƒãƒ—ï¼‰
                harmony.forEach(note => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    
                    osc.frequency.setValueAtTime(note.freq, now + note.start);
                    osc.type = 'sine';
                    
                    gain.gain.setValueAtTime(0, now + note.start);
                    gain.gain.linearRampToValueAtTime(0.3, now + note.start + 0.02); // 0.1 â†’ 0.3
                    gain.gain.exponentialRampToValueAtTime(0.001, now + note.start + note.duration);
                    
                    osc.start(now + note.start);
                    osc.stop(now + note.start + note.duration);
                });
                
                console.log('ğŸº ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬éŸ³å†ç”Ÿå®Œäº†');
                
            } catch (error) {
                console.warn('âš ï¸ ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // çˆ†ç™ºéŸ³ã®ç”Ÿæˆï¼ˆãƒ‰ã‚«ãƒ¼ãƒ³é¢¨ï¼‰
        function playExplosionSound() {
            try {
                const now = audioContext.currentTime;
                
                // ç¬¬1æ®µéšï¼šã€Œãƒ‰ã€éŸ³ï¼ˆè¡æ’ƒéŸ³ï¼‰
                const impact1 = audioContext.createOscillator();
                const impact1Gain = audioContext.createGain();
                
                impact1.connect(impact1Gain);
                impact1Gain.connect(audioContext.destination);
                
                impact1.frequency.setValueAtTime(200, now);
                impact1.frequency.exponentialRampToValueAtTime(80, now + 0.1);
                impact1.type = 'square';
                
                impact1Gain.gain.setValueAtTime(0.7, now); // 0.4 â†’ 0.7
                impact1Gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                
                impact1.start(now);
                impact1.stop(now + 0.1);
                
                // ç¬¬2æ®µéšï¼šã€Œã‚«ãƒ¼ã€éŸ³ï¼ˆæŒç¶šéŸ³ + ãƒã‚¤ã‚ºï¼‰
                setTimeout(() => {
                    const impact2 = audioContext.createOscillator();
                    const impact2Gain = audioContext.createGain();
                    const filter = audioContext.createBiquadFilter();
                    
                    impact2.connect(filter);
                    filter.connect(impact2Gain);
                    impact2Gain.connect(audioContext.destination);
                    
                    impact2.frequency.setValueAtTime(150, audioContext.currentTime);
                    impact2.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
                    impact2.type = 'sawtooth';
                    
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(800, audioContext.currentTime);
                    filter.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.2);
                    
                    impact2Gain.gain.setValueAtTime(0.6, audioContext.currentTime); // 0.3 â†’ 0.6
                    impact2Gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
                    
                    impact2.start(audioContext.currentTime);
                    impact2.stop(audioContext.currentTime + 0.2);
                }, 80);
                
                // ç¬¬3æ®µéšï¼šã€Œãƒ³ã€éŸ³ï¼ˆä½™éŸ»ï¼‰
                setTimeout(() => {
                    // ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºã§ä½™éŸ»
                    const bufferSize = audioContext.sampleRate * 0.15;
                    const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const data = buffer.getChannelData(0);
                    
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize * 0.5));
                    }
                    
                    const noiseSource = audioContext.createBufferSource();
                    const noiseGain = audioContext.createGain();
                    const noiseFilter = audioContext.createBiquadFilter();
                    
                    noiseSource.buffer = buffer;
                    noiseSource.connect(noiseFilter);
                    noiseFilter.connect(noiseGain);
                    noiseGain.connect(audioContext.destination);
                    
                    noiseFilter.type = 'highpass';
                    noiseFilter.frequency.setValueAtTime(400, audioContext.currentTime);
                    
                    noiseGain.gain.setValueAtTime(0.4, audioContext.currentTime); // 0.15 â†’ 0.4
                    noiseGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
                    
                    noiseSource.start(audioContext.currentTime);
                    noiseSource.stop(audioContext.currentTime + 0.15);
                }, 200);
                
                console.log('ğŸ’¥ ãƒ‰ã‚«ãƒ¼ãƒ³éŸ³å†ç”Ÿå®Œäº†');
                
            } catch (error) {
                console.warn('âš ï¸ ãƒ‰ã‚«ãƒ¼ãƒ³éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // éŸ³å£°åˆæˆã«ã‚ˆã‚‹ç™ºè©±ï¼ˆè‡ªç„¶ãªäººé–“ã‚‰ã—ã„å£°è¨­å®šï¼‰
        function speakText(text) {
            try {
                if ('speechSynthesis' in window) {
                    // å‰ã®éŸ³å£°ã‚’åœæ­¢
                    speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ja-JP';
                    utterance.rate = 1.0; // è‡ªç„¶ãªé€Ÿåº¦
                    utterance.pitch = 1.2; // è‡ªç„¶ãªé«˜ã•ï¼ˆ1.8 â†’ 1.2ï¼‰
                    utterance.volume = 1.0; // ã‚¯ãƒªã‚¢ã«
                    
                    // ã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬èªéŸ³å£°ã‚’æ¢ã™
                    const voices = speechSynthesis.getVoices();
                    
                    let selectedVoice = null;
                    
                    // 1. æ¨™æº–çš„ãªæ—¥æœ¬èªéŸ³å£°ã‚’å„ªå…ˆï¼ˆè‡ªç„¶ãªéŸ³å£°ï¼‰
                    selectedVoice = voices.find(voice => 
                        voice.lang.includes('ja') && 
                        !voice.name.toLowerCase().includes('novelty') &&
                        !voice.name.toLowerCase().includes('whisper') &&
                        (voice.name.includes('Japanese') || 
                         voice.name.includes('Japan') ||
                         voice.name.includes('Kyoko') ||
                         voice.name.includes('Otoya'))
                    );
                    
                    // 2. å¥³æ€§éŸ³å£°ã§è‡ªç„¶ãªã‚‚ã®
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => 
                            voice.lang.includes('ja') && 
                            (voice.name.includes('Female') ||
                             voice.name.includes('å¥³æ€§') ||
                             voice.name.includes('å¥³'))
                        );
                    }
                    
                    // 3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ—¥æœ¬èªéŸ³å£°
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.lang.includes('ja'));
                    }
                    
                    // 4. ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£°ï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.default);
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        console.log(`ğŸ‘© é¸æŠã•ã‚ŒãŸéŸ³å£°: ${selectedVoice.name} (lang: ${selectedVoice.lang})`);
                    } else {
                        console.log('ğŸ” é©åˆ‡ãªéŸ³å£°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                    }
                    
                    // ç™ºè©±å‰ã«å°‘ã—å¾…æ©Ÿï¼ˆéŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ã®æº–å‚™æ™‚é–“ï¼‰
                    setTimeout(() => {
                        speechSynthesis.speak(utterance);
                        console.log(`ğŸ—£ï¸ è‡ªç„¶ãªéŸ³å£°å†ç”Ÿ: ${text}`);
                    }, 50);
                    
                } else {
                    console.log('ğŸ”‡ éŸ³å£°åˆæˆAPIæœªå¯¾å¿œ');
                }
            } catch (error) {
                console.warn('âš ï¸ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        

        
        // ã‚µãƒ³ãƒ—ãƒ«è¨ˆæ¸¬å™¨ãƒ‡ãƒ¼ã‚¿
        const sampleInstruments = [
            { managementNo: '11A-001', name: 'ãƒãƒ«ãƒãƒ†ã‚¹ã‚¿ï¼ˆã‚¢ãƒŠãƒ­ã‚°ï¼‰', model: 'YX-361TR' },
            { managementNo: '11A-002', name: 'ãƒãƒ«ãƒãƒ†ã‚¹ã‚¿ï¼ˆã‚¢ãƒŠãƒ­ã‚°ï¼‰', model: 'YX-361TR' },
            { managementNo: '11B-003', name: 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ«ãƒãƒ¡ãƒ¼ã‚¿', model: 'TR-6846' },
            { managementNo: '12A-004', name: 'ã‚¯ãƒ©ãƒ³ãƒ—ãƒ¡ãƒ¼ã‚¿', model: 'GE-22' },
            { managementNo: '12A-005', name: 'ã‚¯ãƒ©ãƒ³ãƒ—ãƒ¡ãƒ¼ã‚¿', model: 'GE-22' },
            { managementNo: '15A-006', name: 'æ¸©åº¦è¨ˆï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«ï¼‰', model: 'TD-100' },
            { managementNo: '15A-007', name: 'æ¸©åº¦è¨ˆï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«ï¼‰', model: 'TD-100' },
            { managementNo: '20A-008', name: 'ã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—', model: 'OS-2000' }
        ];
        
        // LocalStorageè‡ªå‹•ä¿å­˜æ©Ÿèƒ½
        function saveToLocalStorage() {
            if (!autoSaveEnabled) return false;
            
            try {
                const instrumentsArray = Array.from(instruments.entries()).map(([key, value]) => ({
                    managementNo: key,
                    ...value,
                    borrowCount: value.borrowCount || 0
                }));
                
                const autoSaveData = {
                    version: '3.5_auto_with_borrower_16',
                    timestamp: new Date().toISOString(),
                    dataFormat: 'auto_save_localstorage_with_borrower_16',
                    instruments: instrumentsArray,
                    activityLog: activityLog,
                    dataSource: dataSource,
                    currentFileName: currentFileName,
                    borrowerNames: borrowerNames,
                    selectedBorrowerIndex: selectedBorrowerIndex,
                    statistics: {
                        total: instruments.size,
                        available: Array.from(instruments.values()).filter(i => i.status === 'available').length,
                        borrowed: Array.from(instruments.values()).filter(i => i.status === 'borrowed').length,
                        error: Array.from(instruments.values()).filter(i => i.status === 'error').length
                    },
                    autoSaveInfo: {
                        saveTime: new Date().toISOString(),
                        instrumentCount: instruments.size,
                        method: 'localStorage'
                    }
                };
                
                localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(autoSaveData));
                lastAutoSaveTime = new Date();
                updateAutoSaveDisplay();
                
                console.log('ğŸ’¾ LocalStorageè‡ªå‹•ä¿å­˜å®Œäº†:', instruments.size, 'å°');
                return true;
                
            } catch (error) {
                console.error('âŒ LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                updateAutoSaveDisplay('error');
                return false;
            }
        }
        
        // LocalStorageã‹ã‚‰ã®è‡ªå‹•èª­ã¿è¾¼ã¿
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(LOCALSTORAGE_KEY);
                if (!savedData) {
                    console.log('ğŸ’¡ LocalStorage: ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—');
                    return false;
                }
                
                const autoSaveData = JSON.parse(savedData);
                console.log('ğŸ”„ LocalStorageè‡ªå‹•èª­ã¿è¾¼ã¿é–‹å§‹');
                console.log('ä¿å­˜æ—¥æ™‚:', autoSaveData.timestamp);
                console.log('æ©Ÿå™¨æ•°:', autoSaveData.instruments ? autoSaveData.instruments.length : 0);
                
                if (autoSaveData.instruments && Array.isArray(autoSaveData.instruments)) {
                    instruments.clear();
                    
                    autoSaveData.instruments.forEach((item, index) => {
                        try {
                            const managementNo = item.managementNo;
                            if (!managementNo || !item.name) {
                                console.warn(`è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®ç„¡åŠ¹ã‚¢ã‚¤ãƒ†ãƒ [${index}]:`, item);
                                return;
                            }
                            
                            const instrument = {
                                managementNo: managementNo,
                                name: String(item.name || '').trim(),
                                model: String(item.model || '').trim(),
                                status: item.status || 'available',
                                borrower: item.borrower || null,
                                borrowDate: item.borrowDate || null,
                                returnDate: item.returnDate || null,
                                borrowCount: item.borrowCount || 0
                            };
                            
                            instruments.set(managementNo, instrument);
                        } catch (itemError) {
                            console.error(`è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚¨ãƒ©ãƒ¼[${index}]:`, itemError);
                        }
                    });
                    
                    if (autoSaveData.activityLog && Array.isArray(autoSaveData.activityLog)) {
                        activityLog = autoSaveData.activityLog;
                    }
                    
                    // æŒå‡ºè€…åãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                    if (autoSaveData.borrowerNames && Array.isArray(autoSaveData.borrowerNames)) {
                        borrowerNames = autoSaveData.borrowerNames.slice(0, 16);
                        while (borrowerNames.length < 16) {
                            borrowerNames.push('');
                        }
                        saveBorrowerNamesToStorage();
                    }
                    
                    if (typeof autoSaveData.selectedBorrowerIndex === 'number') {
                        selectedBorrowerIndex = autoSaveData.selectedBorrowerIndex;
                    }
                    
                    dataSource = 'LocalStorageè‡ªå‹•ä¿å­˜';
                    currentFileName = 'auto_save.json';
                    
                    console.log('âœ… LocalStorageè‡ªå‹•èª­ã¿è¾¼ã¿å®Œäº†:', instruments.size, 'å°');
                    addToLog('SYSTEM', 'LocalStorageè‡ªå‹•ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', `æ©Ÿå™¨æ•°: ${instruments.size}å°, ä¿å­˜æ—¥æ™‚: ${new Date(autoSaveData.timestamp).toLocaleString('ja-JP')}`);
                    
                    updateDisplay();
                    updateBorrowerButtons();
                    updateAutoSaveDisplay();
                    return true;
                } else {
                    console.warn('âš ï¸ LocalStorage: ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ LocalStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                addToLog('ERROR', 'LocalStorageè‡ªå‹•èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', error.message);
                return false;
            }
        }
        
        // è‡ªå‹•ä¿å­˜è¡¨ç¤ºã®æ›´æ–°
        function updateAutoSaveDisplay(status = 'success') {
            const autoSaveElement = document.getElementById('autoSaveDisplay');
            if (!autoSaveElement) return;
            
            let statusText = '';
            let statusColor = '';
            
            switch (status) {
                case 'success':
                    if (lastAutoSaveTime) {
                        const timeText = lastAutoSaveTime.toLocaleTimeString('ja-JP', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        statusText = `ğŸ”„ è‡ªå‹•ä¿å­˜æ¸ˆã¿ (${timeText})`;
                        statusColor = '#059669';
                    } else {
                        statusText = 'ğŸ”„ è‡ªå‹•ä¿å­˜æœ‰åŠ¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰';
                        statusColor = '#3b82f6';
                    }
                    break;
                case 'saving':
                    statusText = 'ğŸ’¾ è‡ªå‹•ä¿å­˜ä¸­...';
                    statusColor = '#f59e0b';
                    break;
                case 'error':
                    statusText = 'âŒ è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼';
                    statusColor = '#ef4444';
                    break;
                case 'disabled':
                    statusText = 'ğŸ”‡ è‡ªå‹•ä¿å­˜ç„¡åŠ¹';
                    statusColor = '#9ca3af';
                    break;
                default:
                    statusText = 'ğŸ”„ è‡ªå‹•ä¿å­˜æº–å‚™ä¸­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰';
                    statusColor = '#6b7280';
            }
            
            autoSaveElement.innerHTML = statusText;
            autoSaveElement.style.color = statusColor;
        }
        
        // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã®è‡ªå‹•ä¿å­˜ãƒˆãƒªã‚¬ãƒ¼
        function triggerAutoSave() {
            if (autoSaveEnabled && instruments.size > 0) {
                updateAutoSaveDisplay('saving');
                setTimeout(() => {
                    saveToLocalStorage();
                }, 500);
            }
        }
        
        // LocalStorageè‡ªå‹•ä¿å­˜ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
        function toggleAutoSave() {
            autoSaveEnabled = !autoSaveEnabled;
            
            if (autoSaveEnabled) {
                console.log('ğŸ”„ LocalStorageè‡ªå‹•ä¿å­˜ã‚’æœ‰åŠ¹åŒ–');
                saveToLocalStorage();
                addToLog('SYSTEM', 'LocalStorageè‡ªå‹•ä¿å­˜ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ', '');
            } else {
                console.log('ğŸ”‡ LocalStorageè‡ªå‹•ä¿å­˜ã‚’ç„¡åŠ¹åŒ–');
                updateAutoSaveDisplay('disabled');
                addToLog('SYSTEM', 'LocalStorageè‡ªå‹•ä¿å­˜ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ', '');
            }
            
            updateAutoSaveControls();
        }
        
        // è‡ªå‹•ä¿å­˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«UIã®æ›´æ–°
        function updateAutoSaveControls() {
            const toggleButton = document.getElementById('autoSaveToggle');
            if (toggleButton) {
                if (autoSaveEnabled) {
                    toggleButton.textContent = 'ğŸ”‡ è‡ªå‹•ä¿å­˜OFF';
                    toggleButton.style.background = '#dc2626';
                } else {
                    toggleButton.textContent = 'ğŸ”„ è‡ªå‹•ä¿å­˜ON';
                    toggleButton.style.background = '#059669';
                }
            }
        }
        
        // LocalStorageãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
        function clearLocalStorageData() {
            const result = confirm('LocalStorageã®è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯å½±éŸ¿ã‚’å—ã‘ã¾ã›ã‚“');
            if (result) {
                try {
                    localStorage.removeItem(LOCALSTORAGE_KEY);
                    lastAutoSaveTime = null;
                    updateAutoSaveDisplay();
                    addToLog('SYSTEM', 'LocalStorageè‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', '');
                    console.log('ğŸ—‘ï¸ LocalStorageè‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤');
                } catch (error) {
                    console.error('âŒ LocalStorageå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }
        
        // çµ‚äº†æ™‚ã®è‡ªå‹•ä¿å­˜
        function onBeforeUnload() {
            if (autoSaveEnabled && instruments.size > 0) {
                saveToLocalStorage();
                console.log('ğŸ”„ çµ‚äº†æ™‚LocalStorageè‡ªå‹•ä¿å­˜å®Œäº†');
            }
        }
        
        // QRã‚³ãƒ¼ãƒ‰å‡¦ç†ï¼ˆæŒå‡ºè€…åæ©Ÿèƒ½ä»˜ãï¼‰
        function processQRCode(qrData) {
            console.log('=== QRã‚³ãƒ¼ãƒ‰å‡¦ç†é–‹å§‹ ===');
            console.log('å…¥åŠ›ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(qrData));
            console.log('instruments.size:', instruments.size);
            console.log('é¸æŠä¸­ã®æŒå‡ºè€…:', selectedBorrowerIndex >= 0 ? borrowerNames[selectedBorrowerIndex] : 'æœªé¸æŠ');
            
            if (instruments.size === 0) {
                console.error('âš ï¸ instruments ãŒç©ºã§ã™ï¼');
                const statusCard = document.getElementById('statusCard');
                statusCard.innerHTML = `
                    <div>
                        <h3>âš ï¸ ãƒ‡ãƒ¼ã‚¿æœªèª­ã¿è¾¼ã¿</h3>
                        <p>æ©Ÿå™¨ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</p>
                        <p>èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                        </button>
                    </div>
                `;
                statusCard.className = 'status-card status-error';
                addToLog('ERROR', 'ãƒ‡ãƒ¼ã‚¿æœªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'instruments ãŒç©ºã®çŠ¶æ…‹ã§QRã‚³ãƒ¼ãƒ‰å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ');
                
                playErrorSound();
                return;
            }
            
            let managementNo = qrData.trim().toUpperCase().replace(/\s+/g, '');
            console.log('æ­£è¦åŒ–å¾Œã®ç®¡ç†ç•ªå·:', managementNo);
            
            const instrument = instruments.get(managementNo);
            console.log('æ¤œç´¢çµæœ:', instrument);
            
            const statusCard = document.getElementById('statusCard');
            
            if (!instrument) {
                const allKeys = Array.from(instruments.keys());
                const partialMatches = allKeys.filter(key => 
                    key.includes(managementNo) || managementNo.includes(key)
                );
                
                console.log('éƒ¨åˆ†ä¸€è‡´æ¤œç´¢çµæœ:', partialMatches);
                
                if (partialMatches.length > 0) {
                    console.log('éƒ¨åˆ†ä¸€è‡´ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', partialMatches[0]);
                    processQRCode(partialMatches[0]);
                    return;
                }
                
                console.log('æœªç™»éŒ²æ©Ÿå™¨:', {
                    å…¥åŠ›: qrData,
                    æ­£è¦åŒ–å¾Œ: managementNo,
                    ç™»éŒ²æ©Ÿå™¨æ•°: instruments.size,
                    ç™»éŒ²æ©Ÿå™¨ä¸€è¦§: allKeys.slice(0, 5)
                });
                
                statusCard.innerHTML = `
                    <div>
                        <h3>âŒ æœªç™»éŒ²æ©Ÿå™¨</h3>
                        <p>ç®¡ç†ç•ªå·: <strong>${managementNo}</strong></p>
                        <p>ã“ã®æ©Ÿå™¨ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                        <p style="font-size: 12px; color: #666;">
                            ç™»éŒ²æ©Ÿå™¨æ•°: ${instruments.size}å°<br>
                            ä¾‹: ${allKeys.slice(0, 3).join(', ')}...
                        </p>
                        <button onclick="debugInstruments()" style="margin-top: 8px; padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ” è©³ç´°ç¢ºèª
                        </button>
                    </div>
                `;
                statusCard.className = 'status-card status-error';
                addToLog('ERROR', 'æœªç™»éŒ²æ©Ÿå™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³', `ç®¡ç†ç•ªå·: ${managementNo} (å…ƒãƒ‡ãƒ¼ã‚¿: ${qrData})`);
                
                playErrorSound();
                return;
            }
            
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP');
            
            console.log('å‡¦ç†å‰ã®æ©Ÿå™¨çŠ¶æ…‹:', {
                ç®¡ç†ç•ªå·: managementNo,
                æ©Ÿå™¨å: instrument.name,
                ç¾åœ¨ã®çŠ¶æ…‹: instrument.status,
                æŒå‡ºè€…: instrument.borrower
            });
            
            if (instrument.status === 'available') {
                // æŒå‡ºå‡¦ç†
                if (selectedBorrowerIndex < 0 || !borrowerNames[selectedBorrowerIndex].trim()) {
                    // æŒå‡ºè€…ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã®è­¦å‘Š
                    statusCard.innerHTML = `
                        <div>
                            <h3>âš ï¸ æŒå‡ºè€…æœªé¸æŠ</h3>
                            <p>æ©Ÿå™¨: <strong>${instrument.name}</strong></p>
                            <p>ç®¡ç†ç•ªå·: <strong>${managementNo}</strong></p>
                            <p style="color: #ef4444;">æŒå‡ºè€…ã‚’é¸æŠã—ã¦ã‹ã‚‰å†åº¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</p>
                        </div>
                    `;
                    statusCard.className = 'status-card status-error';
                    addToLog('ERROR', 'æŒå‡ºè€…æœªé¸æŠã‚¨ãƒ©ãƒ¼', `æ©Ÿå™¨: ${managementNo} - ${instrument.name}`);
                    
                    playErrorSound();
                    return;
                }
                
                const borrower = borrowerNames[selectedBorrowerIndex];
                
                instrument.borrowCount = (instrument.borrowCount || 0) + 1;
                
                instrument.status = 'borrowed';
                instrument.borrower = borrower;
                instrument.borrowDate = now.toISOString();
                instrument.returnDate = null;
                
                statusCard.innerHTML = `
                    <div>
                        <h3>ğŸ“¤ æŒå‡ºå®Œäº†</h3>
                        <p>æ©Ÿå™¨: <strong>${instrument.name}</strong></p>
                        <p>ç®¡ç†ç•ªå·: <strong>${managementNo}</strong></p>
                        <p>æŒå‡ºè€…: <strong>${borrower}</strong></p>
                        <p>æŒå‡ºå›æ•°: <strong>${instrument.borrowCount}å›ç›®</strong></p>
                        <p>æŒå‡ºæ—¥æ™‚: ${timeString}</p>
                    </div>
                `;
                statusCard.className = 'status-card status-borrowed';
                addToLog('BORROW', 'æ©Ÿå™¨ã‚’æŒå‡º', `${managementNo} - ${instrument.name} (${borrower}) [${instrument.borrowCount}å›ç›®]`);
                
                playSuccessSound();
                
            } else if (instrument.status === 'borrowed') {
                // è¿”å´å‡¦ç†
                const borrower = instrument.borrower;
                const borrowCount = instrument.borrowCount || 0;
                
                instrument.status = 'available';
                instrument.borrower = null;
                instrument.returnDate = now.toISOString();
                
                statusCard.innerHTML = `
                    <div>
                        <h3>ğŸ“¥ è¿”å´å®Œäº†</h3>
                        <p>æ©Ÿå™¨: <strong>${instrument.name}</strong></p>
                        <p>ç®¡ç†ç•ªå·: <strong>${managementNo}</strong></p>
                        <p>è¿”å´è€…: <strong>${borrower}</strong></p>
                        <p>ç·æŒå‡ºå›æ•°: <strong>${borrowCount}å›</strong></p>
                        <p>è¿”å´æ—¥æ™‚: ${timeString}</p>
                    </div>
                `;
                statusCard.className = 'status-card status-available';
                addToLog('RETURN', 'æ©Ÿå™¨ã‚’è¿”å´', `${managementNo} - ${instrument.name} (${borrower}) [ç·${borrowCount}å›æŒå‡º]`);
                
                playReturnSound();
            }
            
            console.log('å‡¦ç†å¾Œã®æ©Ÿå™¨çŠ¶æ…‹:', {
                ç®¡ç†ç•ªå·: managementNo,
                æ©Ÿå™¨å: instrument.name,
                æ–°ã—ã„çŠ¶æ…‹: instrument.status,
                æŒå‡ºè€…: instrument.borrower
            });
            
            console.log('=== QRã‚³ãƒ¼ãƒ‰å‡¦ç†å®Œäº† ===');
            
            updateStats();
            updateBorrowedList();
            
            triggerAutoSave();
            
            updateAutoSaveStatus('saving', 'ğŸ’¡ ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚LocalStorageè‡ªå‹•ä¿å­˜ãŒå‹•ä½œä¸­ã§ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰ã€‚');
            setTimeout(() => {
                updateAutoSaveStatus('success', 'LocalStorageè‡ªå‹•ä¿å­˜ãŒãƒ¡ã‚¤ãƒ³å‹•ä½œä¸­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰');
            }, 4000);
            
            if (isScanning) {
                setTimeout(() => {
                    if (isScanning) scanLoop();
                }, 1000);
            }
        }
        

        
        // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼æ©Ÿèƒ½
        function toggleScanner() {
            if (typeof jsQR === 'undefined') {
                alert('QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (isScanning) {
                stopScanner();
            } else {
                startScanner();
            }
        }
        
        async function startScanner() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920, min: 640 },
                        height: { ideal: 1080, min: 480 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });
                
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('scanButton').textContent = 'ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ä¸­...';
                document.getElementById('scanButton').disabled = true;
                
                isScanning = true;
                scanLoop();
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('scanButton').textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³';
            document.getElementById('scanButton').disabled = false;
            
            isScanning = false;
        }
        
        function scanLoop() {
            if (!isScanning || typeof jsQR === 'undefined') return;
            
            const video = document.getElementById('video');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                if (canvas.width > 0 && canvas.height > 0) {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    try {
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        
                        if (code && code.data) {
                            const currentTime = Date.now();
                            if (code.data !== lastScannedCode || currentTime - lastScannedTime > SCAN_COOLDOWN) {
                                lastScannedCode = code.data;
                                lastScannedTime = currentTime;
                                
                                processQRCode(code.data);
                                return;
                            }
                        }
                    } catch (error) {
                        console.warn('QRè§£æã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
            }
            
            animationId = requestAnimationFrame(scanLoop);
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const total = instruments.size;
            const available = Array.from(instruments.values()).filter(i => i.status === 'available').length;
            const borrowed = Array.from(instruments.values()).filter(i => i.status === 'borrowed').length;
            const error = Array.from(instruments.values()).filter(i => i.status === 'error').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('availableCount').textContent = available;
            document.getElementById('borrowedCount').textContent = borrowed;
            document.getElementById('errorCount').textContent = error;
            
            let sourceLabel = 'ãƒ•ã‚¡ã‚¤ãƒ«';
            if (dataSource.includes('ã‚µãƒ³ãƒ—ãƒ«')) sourceLabel = 'ã‚µãƒ³ãƒ—ãƒ«';
            document.getElementById('dataSourceLabel').textContent = sourceLabel;
        }
        
        // æŒå‡ºä¸­æ©Ÿå™¨ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãï¼‰
        function updateBorrowedList() {
            const borrowedList = document.getElementById('borrowedList');
            const borrowedInstruments = Array.from(instruments.values()).filter(i => i.status === 'borrowed');
            
            if (borrowedInstruments.length === 0) {
                borrowedList.innerHTML = `
                    <p style="text-align: center; color: #9ca3af; font-size: 14px; padding: 15px;">
                        ç¾åœ¨æŒå‡ºä¸­ã®æ©Ÿå™¨ã¯ã‚ã‚Šã¾ã›ã‚“
                    </p>
                `;
                return;
            }
            
            borrowedInstruments.sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate));
            
            let html = '';
            borrowedInstruments.forEach(instrument => {
                const borrowDate = new Date(instrument.borrowDate);
                const month = borrowDate.getMonth() + 1;
                const day = borrowDate.getDate();
                const hours = borrowDate.getHours().toString().padStart(2, '0');
                const minutes = borrowDate.getMinutes().toString().padStart(2, '0');
                const dateTimeText = `${month}/${day} ${hours}:${minutes}`;
                
                const borrowCount = instrument.borrowCount || 0;
                const countText = borrowCount > 0 ? ` (${borrowCount}å›ç›®)` : '';
                
                html += `
                    <div class="borrowed-item" onclick="confirmReturn('${instrument.managementNo}')" title="ã‚¯ãƒªãƒƒã‚¯ã§è¿”å´å‡¦ç†">
                        <div class="borrowed-info">
                            <div class="borrowed-no">${instrument.managementNo}${countText}</div>
                            <div class="borrowed-name">${instrument.name}</div>
                        </div>
                        <div class="borrowed-details">
                            <div class="borrowed-user">${instrument.borrower}</div>
                            <div class="borrowed-datetime">${dateTimeText}</div>
                        </div>
                    </div>
                `;
            });
            
            borrowedList.innerHTML = html;
        }
        
        // è¿”å´ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        function confirmReturn(managementNo) {
            const instrument = instruments.get(managementNo);
            if (!instrument || instrument.status !== 'borrowed') {
                console.error('è¿”å´å¯¾è±¡ã®æ©Ÿå™¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', managementNo);
                return;
            }
            
            const result = confirm(`è¿”å´ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\næ©Ÿå™¨: ${instrument.name}\nç®¡ç†ç•ªå·: ${managementNo}\næŒå‡ºè€…: ${instrument.borrower}`);
            
            if (result) {
                processQRCode(managementNo);
                console.log(`è¿”å´ç¢ºèªOK: ${managementNo}`);
            } else {
                console.log(`è¿”å´ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ${managementNo}`);
            }
        }
        
        // æ´»å‹•ãƒ­ã‚°æ›´æ–°
        function updateActivityLog() {
            const logContainer = document.getElementById('activityLog');
            
            if (activityLog.length === 0) {
                logContainer.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">ã¾ã æ´»å‹•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let logHTML = '';
            activityLog.slice(-10).reverse().forEach(entry => {
                const time = new Date(entry.timestamp).toLocaleString('ja-JP', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let entryClass = 'other';
                if (entry.action === 'BORROW') entryClass = 'borrow';
                else if (entry.action === 'RETURN') entryClass = 'return';
                else if (entry.action === 'SYSTEM') entryClass = 'system';
                else if (entry.action === 'FILE') entryClass = 'file';
                else if (entry.action === 'ERROR') entryClass = 'error';
                
                logHTML += `
                    <div class="log-entry ${entryClass}">
                        <div class="log-meta">
                            <span class="log-action">${entry.action}</span>
                            <span class="log-time">${time}</span>
                        </div>
                        <div class="log-details">${entry.details}</div>
                    </div>
                `;
            });
            
            logContainer.innerHTML = logHTML;
        }
        
        // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
        function addToLog(action, message, details = '') {
            activityLog.push({
                timestamp: new Date().toISOString(),
                action: action,
                message: message,
                details: details
            });
            
            updateActivityLog();
        }
        
        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            updateStats();
            updateBorrowedList();
            updateFileInfo();
            updateFileSystemSupport();
        }
        
        // File System Access APIã‚µãƒãƒ¼ãƒˆçŠ¶æ³ã®è¡¨ç¤º
        function updateFileSystemSupport() {
            const supportElement = document.getElementById('fileSystemSupport');
            if (supportElement) {
                if ('showSaveFilePicker' in window) {
                    supportElement.innerHTML = 'âœ… <strong>å ´æ‰€æŒ‡å®šä¿å­˜å¯¾å¿œ</strong>: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ™‚ã«ä¿å­˜å ´æ‰€ã‚’é¸æŠå¯èƒ½';
                    supportElement.style.color = '#065f46';
                } else {
                    supportElement.innerHTML = 'âš ï¸ <strong>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜ã®ã¿</strong>: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜';
                    supportElement.style.color = '#92400e';
                }
            }
        }
        
        // éŸ³éŸ¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ›´æ–°
        function updateSoundStatus() {
            const borrowStatus = document.getElementById('borrowSoundStatus');
            const returnStatus = document.getElementById('returnSoundStatus');
            
            if (borrowStatus) {
                borrowStatus.textContent = customBorrowSound ? 'ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«' : 'ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬+éŸ³å£°åˆæˆ';
            }
            
            if (returnStatus) {
                returnStatus.textContent = customReturnSound ? 'ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«' : 'çˆ†ç™ºéŸ³+éŸ³å£°åˆæˆ';
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†é–¢æ•°ï¼ˆæŒå‡ºå›æ•°ã‚«ã‚¦ãƒ³ãƒˆå¯¾å¿œãƒ»æŒå‡ºè€…åãƒ‡ãƒ¼ã‚¿ä»˜ãï¼‰
        async function saveDataToFile(forceDownload = false) {
            try {
                updateAutoSaveStatus('saving', 'ğŸ’¾ ä¿å­˜ä¸­...');
                
                console.log('=== ä¿å­˜å‡¦ç†é–‹å§‹ ===');
                console.log('instruments.size:', instruments.size);
                console.log('forceDownload:', forceDownload);
                
                const instrumentsArray = Array.from(instruments.entries()).map(([key, value]) => {
                    return {
                        managementNo: key,
                        ...value,
                        borrowCount: value.borrowCount || 0
                    };
                });
                
                const borrowStats = {
                    totalBorrows: instrumentsArray.reduce((sum, item) => sum + (item.borrowCount || 0), 0),
                    mostBorrowedInstrument: instrumentsArray.reduce((max, item) => 
                        (item.borrowCount || 0) > (max.borrowCount || 0) ? item : max, 
                        { managementNo: 'N/A', borrowCount: 0 }
                    ),
                    averageBorrows: Math.round((instrumentsArray.reduce((sum, item) => sum + (item.borrowCount || 0), 0) / instrumentsArray.length) * 100) / 100
                };
                
                const saveData = {
                    version: '3.5_with_borrower_16',
                    timestamp: new Date().toISOString(),
                    filename: DATA_FILENAME,
                    totalInstruments: instruments.size,
                    dataFormat: 'key_value_pairs_with_borrow_count_and_borrower_16',
                    instruments: instrumentsArray,
                    activityLog: activityLog,
                    dataSource: dataSource,
                    borrowerNames: borrowerNames,
                    selectedBorrowerIndex: selectedBorrowerIndex,
                    statistics: {
                        total: instruments.size,
                        available: Array.from(instruments.values()).filter(i => i.status === 'available').length,
                        borrowed: Array.from(instruments.values()).filter(i => i.status === 'borrowed').length,
                        error: Array.from(instruments.values()).filter(i => i.status === 'error').length
                    },
                    borrowAnalytics: {
                        ...borrowStats,
                        instrumentsWithBorrows: instrumentsArray.filter(item => (item.borrowCount || 0) > 0).length,
                        instrumentsNeverBorrowed: instrumentsArray.filter(item => (item.borrowCount || 0) === 0).length,
                        topBorrowedInstruments: instrumentsArray
                            .filter(item => (item.borrowCount || 0) > 0)
                            .sort((a, b) => (b.borrowCount || 0) - (a.borrowCount || 0))
                            .slice(0, 5)
                            .map(item => ({
                                managementNo: item.managementNo,
                                name: item.name,
                                borrowCount: item.borrowCount || 0
                            }))
                    },
                    debugInfo: {
                        mapSize: instruments.size,
                        arrayLength: instrumentsArray.length,
                        saveTime: new Date().toISOString(),
                        saveMethod: forceDownload ? 'download' : 'filesystem',
                        dataVersion: '3.5_with_borrower_16'
                    }
                };
                
                if (instrumentsArray.length === 0 && instruments.size > 0) {
                    throw new Error(`ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚¨ãƒ©ãƒ¼: Map.size=${instruments.size}, Array.length=${instrumentsArray.length}`);
                }
                
                const jsonString = JSON.stringify(saveData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                if (!forceDownload && 'showSaveFilePicker' in window) {
                    try {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: DATA_FILENAME,
                            types: [{
                                description: 'JSON files',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                        
                        const writable = await fileHandle.createWritable();
                        await writable.write(jsonString);
                        await writable.close();
                        
                        lastSaveTime = new Date();
                        updateFileInfo();
                        updateAutoSaveStatus('success', 'âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜å®Œäº†ï¼ˆå ´æ‰€æŒ‡å®šï¼‰');
                        addToLog('FILE', 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆå ´æ‰€æŒ‡å®šï¼‰', `ãƒ•ã‚¡ã‚¤ãƒ«: ${DATA_FILENAME}, æ©Ÿå™¨æ•°: ${instruments.size}å°, ç·æŒå‡ºå›æ•°: ${borrowStats.totalBorrows}å›`);
                        
                        console.log('ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†ï¼ˆå ´æ‰€æŒ‡å®šï¼‰:', DATA_FILENAME);
                        console.log('æŒå‡ºå›æ•°çµ±è¨ˆ:', borrowStats);
                        return true;
                        
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log('ä¿å­˜ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                            updateAutoSaveStatus('error', 'âŒ ä¿å­˜ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                            return false;
                        }
                        throw error;
                    }
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = DATA_FILENAME;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    lastSaveTime = new Date();
                    updateFileInfo();
                    updateAutoSaveStatus('success', 'âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜å®Œäº†ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰');
                    addToLog('FILE', 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰', `ãƒ•ã‚¡ã‚¤ãƒ«: ${DATA_FILENAME}, æ©Ÿå™¨æ•°: ${instruments.size}å°, ç·æŒå‡ºå›æ•°: ${borrowStats.totalBorrows}å›`);
                    
                    console.log('ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰:', DATA_FILENAME);
                    console.log('æŒå‡ºå›æ•°çµ±è¨ˆ:', borrowStats);
                    return true;
                }
                
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                updateAutoSaveStatus('error', 'âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
                addToLog('ERROR', 'ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼', error.message);
                return false;
            }
        }
        
        function loadDataFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        processFileData(jsonData, file.name);
                        resolve(true);
                    } catch (error) {
                        console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                        addToLog('ERROR', 'ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', error.message);
                        reject(error);
                    }
                };
                reader.readAsText(file);
            });
        }
        
        function processFileData(jsonData, filename) {
            try {
                console.log('=== ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿å‡¦ç†é–‹å§‹ ===');
                console.log('jsonData version:', jsonData.version);
                console.log('jsonData.instruments type:', Array.isArray(jsonData.instruments) ? 'Array' : typeof jsonData.instruments);
                console.log('jsonData.instruments length:', jsonData.instruments ? jsonData.instruments.length : 0);
                
                let processedData = [];
                
                if (Array.isArray(jsonData)) {
                    processedData = jsonData;
                } else if (jsonData.instruments && Array.isArray(jsonData.instruments)) {
                    processedData = jsonData.instruments;
                } else {
                    throw new Error('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                }
                
                console.log('processedData length:', processedData.length);
                console.log('processedData sample:', processedData.slice(0, 2));
                
                instruments.clear();
                let validCount = 0;
                let invalidCount = 0;
                
                processedData.forEach((item, index) => {
                    try {
                        let managementNo = item.managementNo || item.key || item.id;
                        
                        if (!managementNo || !item.name) {
                            console.warn(`Invalid item at index ${index}:`, item);
                            invalidCount++;
                            return;
                        }
                        
                        managementNo = String(managementNo).trim();
                        
                        const instrument = {
                            managementNo: managementNo,
                            name: String(item.name || '').trim(),
                            model: String(item.model || '').trim(),
                            status: item.status || 'available',
                            borrower: item.borrower || null,
                            borrowDate: item.borrowDate || null,
                            returnDate: item.returnDate || null,
                            borrowCount: item.borrowCount || 0
                        };
                        
                        instruments.set(managementNo, instrument);
                        validCount++;
                        
                        console.log(`Loaded instrument: ${managementNo} -> ${instrument.name}`);
                        
                    } catch (itemError) {
                        console.error(`Error processing item at index ${index}:`, itemError, item);
                        invalidCount++;
                    }
                });
                
                console.log('=== Mapå¾©å…ƒçµæœ ===');
                console.log('instruments.size:', instruments.size);
                console.log('validCount:', validCount);
                console.log('invalidCount:', invalidCount);
                console.log('instruments.keys():', Array.from(instruments.keys()));
                
                if (jsonData.activityLog && Array.isArray(jsonData.activityLog)) {
                    activityLog = jsonData.activityLog;
                    console.log('Activity log restored:', activityLog.length, 'entries');
                } else {
                    activityLog = [];
                    console.log('No activity log found, starting fresh');
                }
                
                // æŒå‡ºè€…åãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                if (jsonData.borrowerNames && Array.isArray(jsonData.borrowerNames)) {
                    borrowerNames = jsonData.borrowerNames.slice(0, 16);
                    while (borrowerNames.length < 16) {
                        borrowerNames.push('');
                    }
                    saveBorrowerNamesToStorage();
                    console.log('Borrower names restored:', borrowerNames);
                }
                
                if (typeof jsonData.selectedBorrowerIndex === 'number') {
                    selectedBorrowerIndex = jsonData.selectedBorrowerIndex;
                    console.log('Selected borrower index restored:', selectedBorrowerIndex);
                }
                
                currentFileName = filename;
                dataSource = jsonData.dataSource || 'ãƒ•ã‚¡ã‚¤ãƒ«';
                
                if (instruments.size === 0 && processedData.length > 0) {
                    throw new Error(`Mapå¾©å…ƒå¤±æ•—: å‡¦ç†ãƒ‡ãƒ¼ã‚¿æ•°=${processedData.length}, Map.size=${instruments.size}`);
                }
                
                updateDisplay();
                updateBorrowerButtons();
                updateFileInfo();
                addToLog('FILE', 'ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', `ãƒ•ã‚¡ã‚¤ãƒ«: ${filename}, æ©Ÿå™¨æ•°: ${instruments.size}å° (æœ‰åŠ¹: ${validCount}, ç„¡åŠ¹: ${invalidCount})`);
                
                triggerAutoSave();
                
                console.log('=== ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Œäº† ===');
                console.log('æœ€çµ‚çµæœ:', {
                    ãƒ•ã‚¡ã‚¤ãƒ«: filename,
                    æ©Ÿå™¨æ•°: instruments.size,
                    ãƒ­ã‚°æ•°: activityLog.length,
                    æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿: validCount,
                    ç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿: invalidCount,
                    æŒå‡ºè€…åæ•°: borrowerNames.filter(n => n).length
                });
                
                if (invalidCount > 0) {
                    updateAutoSaveStatus('error', `âš ï¸ èª­ã¿è¾¼ã¿å®Œäº†: ${validCount}ä»¶æˆåŠŸ, ${invalidCount}ä»¶å¤±æ•—`);
                }
                
            } catch (error) {
                console.error('=== ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼ ===');
                console.error('Error details:', error);
                console.error('jsonData structure:', Object.keys(jsonData));
                throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // UIæ›´æ–°é–¢æ•°
        function updateAutoSaveStatus(status, message) {
            const statusElement = document.getElementById('autoSaveStatus');
            const messageElement = document.getElementById('autoSaveMessage');
            
            statusElement.className = `auto-save-status ${status}`;
            messageElement.textContent = message;
            
            if (status === 'success') {
                setTimeout(() => {
                    statusElement.className = 'auto-save-status';
                    messageElement.innerHTML = 'LocalStorageè‡ªå‹•ä¿å­˜ãŒãƒ¡ã‚¤ãƒ³å‹•ä½œä¸­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰';
                }, 3000);
            }
        }
        
        function updateFileInfo() {
            document.getElementById('currentFileName').textContent = dataSource.includes('LocalStorage') ? 
                'LocalStorageè‡ªå‹•ä¿å­˜' : (currentFileName || 'LocalStorageè‡ªå‹•ä¿å­˜');
            document.getElementById('lastModified').textContent = lastAutoSaveTime ? 
                lastAutoSaveTime.toLocaleString('ja-JP') : (lastSaveTime ? lastSaveTime.toLocaleString('ja-JP') : '-');
            document.getElementById('fileInstrumentCount').textContent = `${instruments.size}å°`;
        }
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜è¨­å®šï¼ˆè‡ªå‹•ä¿å­˜ãŒãƒ¡ã‚¤ãƒ³ï¼‰
        function setupManualSaveOnly() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            
            addToLog('SYSTEM', 'LocalStorageè‡ªå‹•ä¿å­˜ãƒ¡ã‚¤ãƒ³ + ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ‰‹å‹•ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸ', 'ãƒ¡ã‚¤ãƒ³: è‡ªå‹•ä¿å­˜ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: æ‰‹å‹•ä¿å­˜');
            
            updateAutoSaveStatus('success', 'âœ… LocalStorageè‡ªå‹•ä¿å­˜ãŒãƒ¡ã‚¤ãƒ³å‹•ä½œä¸­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰');
        }
        
        // æ‰‹å‹•æ“ä½œé–¢æ•°ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ç”¨ï¼‰
        async function manualSave() {
            if (instruments.size === 0) {
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if ('showSaveFilePicker' in window) {
                const choice = confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆæ–¹å¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š

OK: ğŸ“ ä¿å­˜å ´æ‰€ã‚’æŒ‡å®šã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ

æ¨å¥¨: ä¿å­˜å ´æ‰€ã‚’æŒ‡å®šã™ã‚‹æ–¹ãŒç®¡ç†ã—ã‚„ã™ã„ã§ã™ã€‚`);
                
                if (choice) {
                    await saveDataToFile(false);
                } else {
                    await saveDataToFile(true);
                }
            } else {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã€‚');
                await saveDataToFile(true);
            }
        }
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼ˆæ—¥æ™‚ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åï¼‰
        async function exportBackup() {
            if (instruments.size === 0) {
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const backupFilename = `mr_qr_backup_${getDateString()}.json`;
            
            try {
                const instrumentsArray = Array.from(instruments.entries()).map(([key, value]) => ({
                    managementNo: key,
                    ...value,
                    borrowCount: value.borrowCount || 0
                }));
                
                const totalBorrows = instrumentsArray.reduce((sum, item) => sum + (item.borrowCount || 0), 0);
                
                const backupData = {
                    version: '3.5_with_borrower_16',
                    timestamp: new Date().toISOString(),
                    filename: backupFilename,
                    totalInstruments: instruments.size,
                    dataFormat: 'backup_with_borrow_count_and_borrower_16',
                    instruments: instrumentsArray,
                    activityLog: activityLog,
                    dataSource: dataSource,
                    borrowerNames: borrowerNames,
                    selectedBorrowerIndex: selectedBorrowerIndex,
                    backupNote: 'æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæŒå‡ºå›æ•°çµ±è¨ˆãƒ»æŒå‡ºè€…å16åä»˜ãï¼‰',
                    statistics: {
                        total: instruments.size,
                        available: Array.from(instruments.values()).filter(i => i.status === 'available').length,
                        borrowed: Array.from(instruments.values()).filter(i => i.status === 'borrowed').length,
                        error: Array.from(instruments.values()).filter(i => i.status === 'error').length
                    },
                    borrowAnalytics: {
                        totalBorrows: totalBorrows,
                        instrumentsWithBorrows: instrumentsArray.filter(item => (item.borrowCount || 0) > 0).length,
                        averageBorrows: Math.round((totalBorrows / instrumentsArray.length) * 100) / 100
                    }
                };
                
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = backupFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateAutoSaveStatus('success', 'âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†');
                addToLog('FILE', 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ', `ãƒ•ã‚¡ã‚¤ãƒ«: ${backupFilename}, æ©Ÿå™¨æ•°: ${instruments.size}å°`);
                
            } catch (error) {
                console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                updateAutoSaveStatus('error', 'âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        function loadNewFile() {
            document.getElementById('fileInput').click();
        }
        
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadSampleData() {
            console.log('=== ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ ===');
            
            instruments.clear();
            
            sampleInstruments.forEach((item, index) => {
                const managementNo = item.managementNo;
                const instrument = {
                    managementNo: managementNo,
                    name: item.name,
                    model: item.model,
                    status: 'available',
                    borrower: null,
                    borrowDate: null,
                    returnDate: null,
                    borrowCount: 0
                };
                
                instruments.set(managementNo, instrument);
                console.log(`Sample[${index}]: ${managementNo} -> ${instrument.name}`);
            });
            
            console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', {
                èª­ã¿è¾¼ã¿æ•°: sampleInstruments.length,
                Map_size: instruments.size,
                keys: Array.from(instruments.keys())
            });
            
            activityLog = [];
            currentFileName = DATA_FILENAME;
            dataSource = 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆLocalStorageè‡ªå‹•ä¿å­˜ä¸­ï¼‰';
            
            updateDisplay();
            updateFileInfo();
            addToLog('SYSTEM', 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', `${sampleInstruments.length}å°ã®æ©Ÿå™¨ãƒ‡ãƒ¼ã‚¿`);
            
            triggerAutoSave();
            
            const statusCard = document.getElementById('statusCard');
            statusCard.textContent = 'ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„';
            statusCard.className = 'status-card';
            
            const isValid = validateInstrumentsData();
            if (!isValid) {
                console.error('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã«æ•´åˆæ€§ã®å•é¡ŒãŒã‚ã‚Šã¾ã™');
                updateAutoSaveStatus('error', 'âš ï¸ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼');
            } else {
                updateAutoSaveStatus('saving', 'ğŸ’¡ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚LocalStorageè‡ªå‹•ä¿å­˜ãŒæœ‰åŠ¹ã§ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰ã€‚');
                setTimeout(() => {
                    updateAutoSaveStatus('success', 'âœ… LocalStorageè‡ªå‹•ä¿å­˜ãƒ¡ã‚¤ãƒ³é‹ç”¨ä¸­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰');
                }, 5000);
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨é–¢æ•°ï¼ˆæŒå‡ºå›æ•°çµ±è¨ˆä»˜ãï¼‰
        function debugInstruments() {
            console.log('=== instruments è©³ç´°ãƒ‡ãƒãƒƒã‚° ===');
            console.log('Map.size:', instruments.size);
            console.log('Map.keys():', Array.from(instruments.keys()));
            console.log('Map.values():', Array.from(instruments.values()));
            console.log('Map.entries():', Array.from(instruments.entries()));
            console.log('Constructor:', instruments.constructor.name);
            console.log('Is Map:', instruments instanceof Map);
            
            const instrumentsArray = Array.from(instruments.values());
            const borrowCounts = instrumentsArray.map(item => item.borrowCount || 0);
            const totalBorrows = borrowCounts.reduce((sum, count) => sum + count, 0);
            const maxBorrows = Math.max(...borrowCounts);
            const instrumentsWithBorrows = instrumentsArray.filter(item => (item.borrowCount || 0) > 0);
            
            console.log('=== æŒå‡ºå›æ•°çµ±è¨ˆ ===');
            console.log('ç·æŒå‡ºå›æ•°:', totalBorrows);
            console.log('æœ€å¤§æŒå‡ºå›æ•°:', maxBorrows);
            console.log('æŒå‡ºå±¥æ­´ã®ã‚ã‚‹æ©Ÿå™¨æ•°:', instrumentsWithBorrows.length);
            console.log('å¹³å‡æŒå‡ºå›æ•°:', Math.round((totalBorrows / instrumentsArray.length) * 100) / 100);
            
            const instrumentsArrayWithEntries = Array.from(instruments.entries());
            instrumentsArrayWithEntries.forEach(([key, value], index) => {
                console.log(`Instrument[${index}]:`, {
                    key: key,
                    value: value,
                    keyType: typeof key,
                    valueType: typeof value,
                    borrowCount: value.borrowCount || 0
                });
            });
            
            if (instruments.size > 0) {
                const firstKey = Array.from(instruments.keys())[0];
                console.log('First instrument details:', {
                    key: firstKey,
                    value: instruments.get(firstKey),
                    hasKey: instruments.has(firstKey)
                });
            }
            
            const topBorrowed = instrumentsWithBorrows
                .sort((a, b) => (b.borrowCount || 0) - (a.borrowCount || 0))
                .slice(0, 5);
            
            console.log('=== æŒå‡ºå›æ•°TOP5 ===');
            topBorrowed.forEach((item, index) => {
                console.log(`${index + 1}ä½: ${item.managementNo} - ${item.name} (${item.borrowCount}å›)`);
            });
            
            console.log('=== æŒå‡ºè€…åç®¡ç† ===');
            console.log('ç™»éŒ²æŒå‡ºè€…å:', borrowerNames);
            console.log('é¸æŠä¸­ã®æŒå‡ºè€…:', selectedBorrowerIndex >= 0 ? borrowerNames[selectedBorrowerIndex] : 'æœªé¸æŠ');
            
            const details = `
instruments è©³ç´°æƒ…å ±:
ãƒ»ã‚µã‚¤ã‚º: ${instruments.size}
ãƒ»ã‚­ãƒ¼æ•°: ${Array.from(instruments.keys()).length}
ãƒ»å€¤æ•°: ${Array.from(instruments.values()).length}
ãƒ»Mapå½¢å¼: ${instruments instanceof Map ? 'ã¯ã„' : 'ã„ã„ãˆ'}

ğŸ“Š æŒå‡ºå›æ•°çµ±è¨ˆ:
ãƒ»ç·æŒå‡ºå›æ•°: ${totalBorrows}å›
ãƒ»æœ€å¤§æŒå‡ºå›æ•°: ${maxBorrows}å›
ãƒ»æŒå‡ºå±¥æ­´ã®ã‚ã‚‹æ©Ÿå™¨: ${instrumentsWithBorrows.length}å°
ãƒ»å¹³å‡æŒå‡ºå›æ•°: ${Math.round((totalBorrows / instrumentsArray.length) * 100) / 100}å›

            ğŸ‘¤ æŒå‡ºè€…åç®¡ç†:
ãƒ»ç™»éŒ²æ•°: ${borrowerNames.filter(name => name.trim()).length}/16
ãƒ»é¸æŠä¸­: ${selectedBorrowerIndex >= 0 ? borrowerNames[selectedBorrowerIndex] : 'æœªé¸æŠ'}

ç™»éŒ²ç®¡ç†ç•ªå· (æœ€åˆã®5ã¤):
${Array.from(instruments.keys()).slice(0, 5).join('\n')}

${instruments.size > 5 ? `\n...ä»–${instruments.size - 5}ä»¶` : ''}

ğŸ† æŒå‡ºå›æ•°TOP3:
${topBorrowed.slice(0, 3).map((item, i) => `${i + 1}ä½: ${item.managementNo} (${item.borrowCount}å›)`).join('\n')}

è©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã§ãã¾ã™ã€‚
            `;
            
            alert(details);
        }
        
        // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        function validateInstrumentsData() {
            console.log('=== ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ===');
            
            const issues = [];
            
            if (!(instruments instanceof Map)) {
                issues.push('instruments ãŒMapå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
            }
            
            if (instruments.size === 0) {
                issues.push('instruments ãŒç©ºã§ã™');
            }
            
            const instrumentsArray = Array.from(instruments.entries());
            instrumentsArray.forEach(([key, value], index) => {
                if (typeof key !== 'string' || key.trim() === '') {
                    issues.push(`ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${index}: ç„¡åŠ¹ãªã‚­ãƒ¼ "${key}"`);
                }
                
                if (!value || typeof value !== 'object') {
                    issues.push(`ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${index}: ç„¡åŠ¹ãªå€¤`);
                } else {
                    if (!value.managementNo || !value.name) {
                        issues.push(`ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${index}: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³ (managementNo: ${value.managementNo}, name: ${value.name})`);
                    }
                    
                    if (value.managementNo !== key) {
                        issues.push(`ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${index}: ã‚­ãƒ¼ã¨ç®¡ç†ç•ªå·ãŒä¸ä¸€è‡´ (key: ${key}, managementNo: ${value.managementNo})`);
                    }
                }
            });
            
            console.log('æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ:', {
                ç·ä»¶æ•°: instruments.size,
                å•é¡Œæ•°: issues.length,
                å•é¡Œè©³ç´°: issues
            });
            
            if (issues.length > 0) {
                console.error('ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:', issues);
                return false;
            } else {
                console.log('ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: OK');
                return true;
            }
        }
        
        function getDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}${month}${day}_${hours}${minutes}`;
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
            initAudioSystem();
            
            // éŸ³å£°åˆæˆã®åˆæœŸåŒ–
            if ('speechSynthesis' in window) {
                // éŸ³å£°ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
                if (speechSynthesis.getVoices().length === 0) {
                    speechSynthesis.addEventListener('voiceschanged', function() {
                        console.log('ğŸ—£ï¸ éŸ³å£°åˆæˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                    });
                } else {
                    console.log('ğŸ—£ï¸ éŸ³å£°åˆæˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                }
            }
            
            if (audioContext) {
                if (audioContext.state === 'suspended') {
                    console.log('ğŸ”‡ éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ : å¾…æ©Ÿä¸­ - ã‚¯ãƒªãƒƒã‚¯ã§è‡ªå‹•æœ‰åŠ¹åŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰');
                } else if (audioContext.state === 'running') {
                    console.log('ğŸ”Š éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ : æœ‰åŠ¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰');
                } else {
                    console.log('ğŸ”Š éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ : æœ‰åŠ¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰');
                }
            } else {
                console.log('âŒ éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ : ã‚¨ãƒ©ãƒ¼');
            }
            
            // æŒå‡ºè€…åã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
            initBorrowerNames();
            
            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜è¨­å®š
            setupManualSaveOnly();
            
            // LocalStorageè‡ªå‹•èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
            const autoLoaded = loadFromLocalStorage();
            
            if (!autoLoaded) {
                // LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                loadSampleData();
            }
            
            // è‡ªå‹•ä¿å­˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
            updateAutoSaveControls();
            updateAutoSaveDisplay();
            
            // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('borrowSoundInput').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        if (!audioContext) {
                            await initAudioSystem();
                        }
                        if (audioContext.state === 'suspended') {
                            await audioContext.resume();
                        }
                        
                        await loadAudioFile(file, 'borrow');
                        updateSoundStatus();
                        alert(`æŒå‡ºéŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‚’è¨­å®šã—ã¾ã—ãŸï¼\nãƒ†ã‚¹ãƒˆå†ç”Ÿã§ç¢ºèªã§ãã¾ã™ã€‚`);
                    } catch (error) {
                        console.error('æŒå‡ºéŸ³ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                        alert(`éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${error.message}`);
                    }
                }
                e.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            });
            
            document.getElementById('returnSoundInput').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        if (!audioContext) {
                            await initAudioSystem();
                        }
                        if (audioContext.state === 'suspended') {
                            await audioContext.resume();
                        }
                        
                        await loadAudioFile(file, 'return');
                        updateSoundStatus();
                        alert(`è¿”å´éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‚’è¨­å®šã—ã¾ã—ãŸï¼\nãƒ†ã‚¹ãƒˆå†ç”Ÿã§ç¢ºèªã§ãã¾ã™ã€‚`);
                    } catch (error) {
                        console.error('è¿”å´éŸ³ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                        alert(`éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${error.message}`);
                    }
                }
                e.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            });
            
            // éŸ³å£°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®åˆæœŸåŒ–
            updateSoundStatus();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
            document.getElementById('fileInput').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        await loadDataFromFile(file);
                        updateAutoSaveStatus('success', 'âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
                    } catch (error) {
                        updateAutoSaveStatus('error', 'âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    }
                }
            });
            

            
            // è‡ªå‹•éŸ³éŸ¿ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONå¯¾å¿œï¼‰
            document.addEventListener('click', function autoActivateAudio() {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('ğŸµ éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆå®Œäº†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰');
                        
                        // åˆå›ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆæ™‚ã«è»½ããƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ã‚’é³´ã‚‰ã—ã¦ç¢ºèª
                        setTimeout(() => {
                            playBeepSound(523, 150, 'success'); // è»½ã„ãƒ‰éŸ³
                            setTimeout(() => playBeepSound(659, 150, 'success'), 170); // è»½ã„ãƒŸéŸ³
                        }, 200);
                    });
                }
                // ä¸€åº¦å®Ÿè¡Œã—ãŸã‚‰å‰Šé™¤
                document.removeEventListener('click', autoActivateAudio);
            });
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('borrowerModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeBorrowerEditor();
                }
            });
            
            // çµ‚äº†æ™‚è‡ªå‹•ä¿å­˜ã®è¨­å®š
            window.addEventListener('beforeunload', onBeforeUnload);
            
            // visibilitychangeæ™‚ã®è‡ªå‹•ä¿å­˜ï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆç­‰ï¼‰
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    if (autoSaveEnabled && instruments.size > 0) {
                        saveToLocalStorage();
                        console.log('ğŸ”„ ã‚¿ãƒ–éè¡¨ç¤ºæ™‚LocalStorageè‡ªå‹•ä¿å­˜å®Œäº†');
                    }
                }
            });
            
            console.log('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº† - LocalStorageè‡ªå‹•ä¿å­˜ãƒ¡ã‚¤ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰ + ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ‰‹å‹•ä¿å­˜ï¼ˆãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ãƒ»çˆ†ç™ºéŸ³ãƒ»éŸ³å£°å¯¾å¿œãƒ»ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°å¯¾å¿œãƒ»æŒå‡ºè€…åæ©Ÿèƒ½ä»˜ããƒ»16åå¯¾å¿œï¼‰');
        });
    </script>
</body>
</html>